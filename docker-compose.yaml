name: keds

services:

  knots:
    container_name: knots
    build:
      context: docker/knots
      args:
        - KNOTS_VERSION=28.1.knots20250305
    # Pass credentials as environment variables from .env file
    environment:
      - RPC_USER=${RPC_USER}
      - RPC_PASSWORD=${RPC_PASSWORD}
    volumes:
      - ${PWD}/data/bitcoin:/data/.bitcoin
    restart: on-failure
    ports:
      # RPC interface
      - "8332:8332"
      # P2P network
      - "8333:8333"
      # ZMQ ports
      - "8443:8443"

  electrs:
    container_name: electrs
    depends_on:
      - knots
    build:
      context: docker/electrs
    environment:
      # Use variables defined in .env file
      BITCOIN_RPC_USER: "${RPC_USER}"
      BITCOIN_RPC_PASSWORD: "${RPC_PASSWORD}"
      ELECTRS_NETWORK: "bitcoin"
      ELECTRS_DAEMON_RPC_ADDR: "knots:8332"
      ELECTRS_DAEMON_P2P_ADDR: "knots:8333"
      ELECTRS_ELECTRUM_RPC_ADDR: "0.0.0.0:50001"
      ELECTRS_SERVER_BANNER: "Electrs"
      ELECTRS_INDEX_BATCH_SIZE: "2000"
      ELECTRS_WAIT_DURATION_SECS: "1"
      ELECTRS_MONITORING_ADDR: "0.0.0.0:4224"
      ELECTRS_LOG_FILTERS: "INFO"
      ELECTRS_DB_DIR: "/data" # Ensure this is set for the entrypoint
    volumes:
      - ${PWD}/data/electrs:/data
    restart: always
    ports:
      - "50001:50001"
      - "4224:4224" # Expose metrics port

  datum:
    container_name: datum
    depends_on:
      - knots
    build:
      context: docker/datum
    environment:
      DATUM_RPCURL: "knots:8332"
      # Use variable defined in .env file
      DATUM_POOL_ADDRESS: "${POOL_ADDRESS}"
      DATUM_COINBASE_TAG_PRIMARY: "DATUM Gateway"
      # Use variable defined in .env file
      DATUM_COINBASE_TAG_SECONDARY: "${COINBASE_TAG_SECONDARY}"
    ports:
      - "23334:23334"
      - "8081:8080"

  specter:
    container_name: specter
    build:
      context: docker/specter
    # Pass credentials for node config
    environment:
      - RPC_USER=${RPC_USER}
      - RPC_PASSWORD=${RPC_PASSWORD}
    restart: always
    volumes:
      - ${PWD}/data/specter:/data/.specter
    ports:
      - "25441:25441"

  cpuminer:
    container_name: cpuminer
    build:
      context: docker/cpuminer
    # Use variable defined in .env file for the user argument
    command: ["--url=stratum+tcp://datum:23334", "--user=${POOL_ADDRESS}", "--pass=x"]
    restart: always
    depends_on:
      - datum
    # cpu limit 30% of the available cores to avoid overloading the system
    cpus: 0.3
